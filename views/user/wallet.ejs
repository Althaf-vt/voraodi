<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>wallet</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/user/wallet.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <%- include('../../views/partials/user/header') %>

    <div class="wallet-container">
        <div class="header">
            <div class="profile-section">
                <img src="<%= user.image %>" alt="image" class="profile-image">
                <div class="profile-text">
                    <h1>YOUR WALLET <span><%= user.name %></span></h1>
                    <p>Manage your wallet and transactions</p>
                </div>
            </div>
        </div>
        
        <div class="wallet-content">
            <!-- Wallet Summary Cards -->
            <div class="wallet-cards">
                <!-- Balance Card -->
                <div class="wallet-card balance-card">
                    <div class="icon-container">
                        <i class="card-icon" data-lucide="wallet"></i>
                    </div>
                    <h3>Wallet Balance</h3>
                    <p class="balance-amount">₹ <span id="walletBalance"><%= wallet.balance || 0 %></span></p>
                    <div class="balance-stats">
                        <div class="stat-item">
                            <span class="stat-label">Total Credited</span>
                            <span class="stat-value credit">₹ <%= creditTotal %></span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Total Debited</span>
                            <span class="stat-value debit">₹ <%= debitTotal %></span>
                        </div>
                    </div>
                    <div class="last-updated">
                        <i data-lucide="clock"></i>
                        Last updated: <time><%= new Date(lastUpdated).toLocaleDateString() %></time>
                    </div>
                </div>
                
                <!-- Referral Card -->
                <div class="wallet-card referral-card">
                    <div class="icon-container">
                        <i class="card-icon" data-lucide="gift"></i>
                    </div>
                    <h3>Your Referral Code</h3>
                    <p>Share your code with friends and earn rewards</p>
                    <div class="referral-code-display">
                        <span class="referral-code" id="referralCode"><%= user.referralCode %></span>
                        <button class="copy-code-btn" onclick="copyReferralCode()">
                            <i data-lucide="copy"></i>
                        </button>
                    </div>
                    <span class="reward-text">Earn ₹100 for each successful referral</span>
                </div>
            </div>
            
            <!-- Transaction Section -->
            <div class="transaction-section">
                <div class="section-header">
                    <h2>Transaction History</h2>
                    <div class="transaction-filters">
                        <select id="typeFilter" class="filter-select">
                            <option value="all">All Transactions</option>
                            <option value="credit">Credit</option>
                            <option value="debit">Debit</option>
                            <option value="refund">Refund</option>
                            <option value="cashback">Cashback</option>
                        </select>
                        <select id="timeFilter" class="filter-select">
                            <option value="30">Last 30 Days</option>
                            <option value="7">Last 7 Days</option>
                            <option value="365">Last Year</option>
                            <option value="all">All Time</option>
                        </select>
                        <button class="filter-reset" onclick="resetFilters()">
                            <i data-lucide="refresh-ccw"></i>
                            Reset
                        </button>
                    </div>
                </div>
                
                <div class="transactions-container">
                    <% if (wallet.transactions.length === 0) { %>
                        <div class="empty-state">
                            <i data-lucide="wallet"></i>
                            <p>No transactions yet</p>
                        </div>
                    <% } else { %>
                        <% wallet.transactions.slice().reverse().forEach((txn, index) => { %>
                            <div class="transaction-item <%= txn.type %>" 
                                 data-type="<%= txn.type %>" 
                                 data-date="<%= txn.createdAt.toISOString().split('T')[0] %>"
                                 data-index="<%= index %>"
                                 style="<%= index >= 4 ? 'display: none;' : '' %>">
                                
                                <div class="transaction-icon <%= txn.type %>">
                                    <% if (txn.type === 'credit') { %>
                                        <i data-lucide="plus-circle"></i>
                                    <% } else { %>
                                        <i data-lucide="minus-circle"></i>
                                    <% } %>
                                </div>
                                
                                <div class="transaction-details">
                                    <h4 class="transaction-title">
                                        <% if (txn.reason && txn.reason !== "Wallet transaction") { %>
                                            <%= txn.reason %>
                                        <% } else if (txn.type === 'credit') { %>
                                            Money Added
                                        <% } else { %>
                                            Purchase Payment
                                        <% } %>
                                    </h4>
                                    <p class="transaction-description">
                                        <% if (txn.orderId) { %>
                                            Order #<%= txn.orderId %>
                                        <% } else { %>
                                            Wallet transaction
                                        <% } %>
                                    </p>
                                    <span class="transaction-date">
                                        <i data-lucide="calendar"></i>
                                        <%= new Date(txn.createdAt).toLocaleString('en-IN', { dateStyle: 'medium', timeStyle: 'short' }) %>
                                    </span>
                                </div>
                                
                                <div class="transaction-amount <%= txn.type %>">
                                    <span class="amount"><%= txn.type === 'credit' ? '+' : '-' %>₹<%= txn.amount.toFixed(2) %></span>
                                    <span class="transaction-id">#<%= txn._id.toString().slice(-6).toUpperCase() %></span>
                                </div>
                            </div>
                        <% }) %>
                    <% } %>
                </div>
                
                <% if (wallet.transactions.length > 4) { %>
                    <div class="load-more-section">
                        <button class="load-more-btn">
                            <i data-lucide="chevron-down"></i>
                            Load More Transactions
                        </button>
                    </div>
                <% } %>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        
        // Filter functionality
        function resetFilters() {
            document.getElementById('typeFilter').value = 'all';
            document.getElementById('timeFilter').value = '30';
            filterTransactions();
        }

        function filterTransactions() {
            const typeFilter = document.getElementById('typeFilter').value;
            const timeFilter = document.getElementById('timeFilter').value;
            const transactions = document.querySelectorAll('.transaction-item');
            
            let visibleCount = 0;
            
            transactions.forEach(transaction => {
                let showTransaction = true;
                
                // Type filter
                if (typeFilter !== 'all') {
                    const transactionType = transaction.getAttribute('data-type');
                    if (transactionType !== typeFilter) {
                        showTransaction = false;
                    }
                }
                
                if (showTransaction) {
                    transaction.style.display = 'flex';
                    visibleCount++;
                } else {
                    transaction.style.display = 'none';
                }
            });
        }

        // Add event listeners
        document.getElementById('typeFilter').addEventListener('change', filterTransactions);
        document.getElementById('timeFilter').addEventListener('change', filterTransactions);

        // Load more functionality
        let visibleTransactions = 4;
        const TRANSACTIONS_PER_LOAD = 4;

        function showMoreTransactions() {
            const allTransactions = document.querySelectorAll('.transaction-item');
            const nextVisibleCount = visibleTransactions + TRANSACTIONS_PER_LOAD;

            allTransactions.forEach((txn, index) => {
                if (index < nextVisibleCount) {
                    txn.style.display = 'flex';
                }
            });

            visibleTransactions = nextVisibleCount;

            if (visibleTransactions >= allTransactions.length) {
                document.querySelector('.load-more-section').style.display = 'none';
            }
        }

        if (document.querySelector('.load-more-btn')) {
            document.querySelector('.load-more-btn').addEventListener('click', function() {
                const icon = this.querySelector('i');
                const originalIcon = icon.dataset.lucide;
                
                icon.dataset.lucide = 'loader-2';
                icon.classList.add('animate-spin');
                lucide.createIcons();
                
                setTimeout(() => {
                    showMoreTransactions();
                    icon.dataset.lucide = originalIcon;
                    icon.classList.remove('animate-spin');
                    lucide.createIcons();
                }, 500);
            });
        }

        // Copy referral code functionality
        function copyReferralCode() {
            const referralCode = document.getElementById('referralCode').textContent;
            navigator.clipboard.writeText(referralCode).then(() => {
                const copyBtn = document.querySelector('.copy-code-btn');
                const icon = copyBtn.querySelector('i');
                const originalIcon = icon.dataset.lucide;
                
                icon.dataset.lucide = 'check';
                lucide.createIcons();
                copyBtn.classList.add('copied');
                
                setTimeout(() => {
                    icon.dataset.lucide = originalIcon;
                    lucide.createIcons();
                    copyBtn.classList.remove('copied');
                }, 2000);
            }).catch(() => {
                alert('Failed to copy referral code');
            });
        }
    </script>
</body>
</html>