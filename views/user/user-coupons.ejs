<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coupons | Althaf</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">    
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="/user/user-coupons.css">
</head>
<body>
    <%- include('../../views/partials/user/header') %>

    <div class="coupon-container">
        <div class="header">
            <div class="profile-section">
                <img src="<%= user.image %>" alt="image" class="profile-image">
                <div class="profile-text">
                    <h1>YOUR COUPONS <span><%= user.name %></span></h1>
                    <p>Manage your discount coupons</p>
                </div>
            </div>
            <% if (coupons && coupons.length > 0) { %>
                <div class="coupon-count">
                    <span><%= coupons.length %> <%= coupons.length === 1 ? 'coupon' : 'coupons' %></span>
                </div>
            <% } %>
        </div>

        <% if (coupons && coupons.length > 0) { %>
            <div class="coupon-grid">
                <% coupons.forEach((coupon, index) => { %>
                    <% 
                        const now = new Date();
                        const expireDate = new Date(coupon.expireOn);
                        const isExpired = expireDate < now;
                        const daysLeft = Math.ceil((expireDate - now) / (1000 * 60 * 60 * 24));
                        const isExpiringSoon = daysLeft <= 3 && daysLeft > 0;
                        const usageLeft = coupon.maxUsage - (coupon.usedBy ? coupon.usedBy.length : 0);
                    %>
                    
                    <div class="coupon-card <%= isExpired ? 'expired' : '' %> <%= isExpiringSoon ? 'expiring-soon' : '' %>">
                        <div class="coupon-header">
                            <div class="coupon-value">
                                <span class="amount">₹<%= coupon.amount %></span>
                                <span class="off">OFF</span>
                            </div>
                            <div class="coupon-status">
                                <% if (isExpired) { %>
                                    <span class="status-badge">Expired</span>
                                <% } else if (isExpiringSoon) { %>
                                    <span class="status-badge"><%= daysLeft %> days left</span>
                                <% } else { %>
                                    <span class="status-badge">Active</span>
                                <% } %>
                            </div>
                        </div>

                        <div class="coupon-body">
                            <h3 class="coupon-name"><%= coupon.name %></h3>
                            
                            <div class="coupon-code-section">
                                <span class="coupon-code" id="code-<%= coupon._id %>"><%= coupon.code %></span>
                                <button class="copy-btn" onclick="copyCouponCode('<%= coupon.code %>', '<%= coupon._id %>')" 
                                        <% if (isExpired) { %>disabled<% } %>>
                                    <i data-lucide="copy"></i>
                                </button>
                            </div>

                            <div class="coupon-details">
                                <div class="detail-row">
                                    <span class="detail-label">Min Purchase:</span>
                                    <span class="detail-value">₹<%= coupon.minimumPrice %></span>
                                </div>
                                
                                <div class="detail-row">
                                    <span class="detail-label">Valid Until:</span>
                                    <span class="detail-value">
                                        <%= new Date(coupon.expireOn).toLocaleDateString('en-IN', { 
                                            day: 'numeric', 
                                            month: 'short', 
                                            year: 'numeric' 
                                        }) %>
                                    </span>
                                </div>

                                <div class="detail-row">
                                    <span class="detail-label">Uses Left:</span>
                                    <span class="detail-value"><%= usageLeft %>/<%= coupon.maxUsage %></span>
                                </div>
                            </div>
                        </div>

                        <div class="coupon-footer">
                            <% if (!isExpired) { %>
                                <a href="/shop" class="shop-btn">Shop Now</a>
                            <% } else { %>
                                <button class="shop-btn" disabled>Expired</button>
                            <% } %>
                        </div>
                    </div>
                <% }) %>
            </div>
        <% } else { %>
            <div class="empty-coupons">
                <div class="empty-icon">
                    <i data-lucide="tags" width="60" height="60"></i>
                </div>
                <h2>No Coupons Available</h2>
                <p>You don't have any coupons yet. Shop more to unlock exclusive discounts!</p>
                <a href="/shop" class="continue-shopping-btn">Start Shopping</a>
            </div>
        <% } %>
    </div>

    <script>
        lucide.createIcons();
        
        function copyCouponCode(code, couponId) {
            navigator.clipboard.writeText(code).then(function() {
                const button = document.querySelector(`button[onclick="copyCouponCode('${code}', '${couponId}')"]`);
                const icon = button.querySelector('i');
                const originalIcon = icon.dataset.lucide;
                
                icon.dataset.lucide = 'check';
                lucide.createIcons();
                button.classList.add('copied');
                
                const Toast = Swal.mixin({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000,
                    timerProgressBar: true,
                    customClass: {
                        popup: 'colored-toast'
                    }
                });
                
                Toast.fire({
                    icon: 'success',
                    title: `Coupon code "${code}" copied!`
                });
                
                setTimeout(() => {
                    icon.dataset.lucide = originalIcon;
                    lucide.createIcons();
                    button.classList.remove('copied');
                }, 2000);
                
            }).catch(function(err) {
                console.error('Failed to copy: ', err);
                Swal.fire({
                    toast: true,
                    position: 'top-end',
                    showConfirmButton: false,
                    timer: 2000,
                    icon: 'error',
                    title: 'Failed to copy code'
                });
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            const couponCards = document.querySelectorAll('.coupon-card');
            
            couponCards.forEach((card, index) => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                
                setTimeout(() => {
                    card.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, index * 100);
            });
        });
    </script>
</body>
</html>